<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameOver Studios - Watch Party</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Staatliches&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        :root { 
            --radius: 16px; 
            --shadow-elev: 0 10px 30px rgba(0,0,0,0.18);
        }

        html, body { height: 100%; margin: 0; }
        body {
            font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            color: var(--text); 
            background: var(--bg); 
            line-height: 1.35;
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
            transition: background 400ms ease, color 300ms ease;
        }
        h1, h2, .display { 
            font-family: 'Staatliches', 'Poppins', sans-serif; 
            letter-spacing: .5px; 
        }

        /* Tema GameOver */
        body {
            --bg: radial-gradient(1200px 800px at 10% -10%, #1a0f2e 0%, #0f0520 30%, #0a0a0c 70%) fixed,
                  linear-gradient(180deg, #0a0a0c 0%, #1a1a2e 100%) fixed;
            --text: #f7f7f9;
            --muted: #b4a7ff;
            --surface: rgba(34, 34, 50, 0.85);
            --border: rgba(138, 104, 255, 0.35);
            --accent: #6c5ce7;
            --accent-2: #a29bfe;
            --btn-text: #fff;
            --btn-bg: #6c5ce7;
            --btn-bg-2: #a29bfe;
            --header-grad: linear-gradient(90deg, #6c5ce7, #a29bfe);
            --chip: rgba(108, 92, 231, 0.16);
            --chip-border: rgba(138, 104, 255, 0.35);
            --glow: rgba(108, 92, 231, 0.4);
        }

        .container { 
            max-width: 980px; 
            margin: 0 auto; 
            padding: 16px; 
        }

        /* Header */
        header.app { 
            position: relative; 
            padding: 16px 0 8px; 
        }

        .app-bar { 
            display: grid; 
            grid-template-columns: auto 1fr auto; 
            align-items: center; 
            gap: 12px; 
            position: relative; 
        }

        .brand { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }

        .brand h1 {
            font-size: clamp(22px, 4.2vw, 32px); 
            line-height: 1; 
            margin: 0;
            background: var(--header-grad); 
            -webkit-background-clip: text; 
            background-clip: text; 
            color: transparent;
            text-shadow: 0 2px 30px var(--glow);
        }

        .product-badge { 
            margin-left: 8px; 
            padding: 6px 12px; 
            border-radius: 999px; 
            font-weight: 800; 
            letter-spacing: 1px;
            background: linear-gradient(180deg, var(--btn-bg), var(--btn-bg-2)); 
            color: #fff; 
            font-size: 12px; 
            box-shadow: 0 8px 18px -6px var(--glow); 
            align-self: flex-start; 
        }

        .sub { 
            font-size: 12px; 
            color: var(--muted); 
            margin-top: 4px; 
        }

        .right-controls { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }

        .chip { 
            display: inline-flex; 
            align-items: center; 
            gap: 6px; 
            border-radius: 999px; 
            padding: 8px 12px; 
            background: var(--chip); 
            border: 1px solid var(--chip-border); 
            color: var(--text); 
            backdrop-filter: blur(6px); 
        }

        /* Cards */
        .card { 
            position: relative; 
            margin: 16px auto 20px; 
            padding: clamp(14px, 3.5vw, 22px); 
            background: var(--surface); 
            border: 1px solid var(--border); 
            border-radius: calc(var(--radius) + 6px); 
            box-shadow: var(--shadow-elev); 
            backdrop-filter: blur(8px); 
        }

        .mode-line {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .mode-title { 
            font-size: clamp(18px, 4.3vw, 28px); 
            margin: 0; 
            text-align: left; 
        }

        .mode-sub { 
            color: var(--muted); 
            font-size: 14px; 
            margin-top: 4px; 
            text-align: left; 
        }

        /* Connection Form */
        .connection-form {
            display: grid;
            gap: 16px;
            margin-bottom: 20px;
        }

        .grid { 
            display: grid; 
            gap: 12px; 
        }
        .grid.two { 
            grid-template-columns: 1fr 1fr; 
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label.input-label { 
            font-size: 12px; 
            color: var(--muted); 
            font-weight: 600;
        }

        input[type="text"], input[type="file"], .share-link-input {
            width: 100%; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            background: rgba(255,255,255,0.08);
            padding: 12px 14px; 
            font-size: 15px; 
            color: var(--text); 
            outline: none;
            font-family: 'Poppins', sans-serif;
            transition: border-color 200ms ease, box-shadow 200ms ease;
        }

        input[type="text"]:focus, input[type="file"]:focus, .share-link-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
        }
        
        .share-link-input {
            background: rgba(0,0,0,0.2);
            font-weight: 600;
        }

        input[type="file"] {
            cursor: pointer;
        }

        input[type="file"]::file-selector-button {
            background: var(--btn-bg);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            margin-right: 12px;
        }

        /* Buttons */
        button.btn {
            appearance: none; 
            border: 0; 
            border-radius: 12px; 
            padding: 12px 20px; 
            font-weight: 700; 
            font-size: 14px; 
            cursor: pointer;
            color: var(--btn-text); 
            background: linear-gradient(180deg, var(--btn-bg), var(--btn-bg-2)); 
            box-shadow: 0 10px 20px -6px var(--glow);
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            transition: transform 120ms ease, filter 160ms ease, opacity 160ms ease; 
            min-height: 44px;
            font-family: 'Poppins', sans-serif;
        }

        button.btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
        }

        button.btn:hover:not(:disabled) { 
            transform: translateY(-1px); 
            filter: brightness(1.08); 
        }

        .btn.secondary { 
            background: rgba(255,255,255,0.08); 
            color: var(--text); 
            border: 1px solid var(--border); 
            box-shadow: var(--shadow-elev); 
        }

        .btn.secondary:hover:not(:disabled) {
            background: rgba(255,255,255,0.12);
        }

        .controls { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 12px; 
            margin-top: 16px; 
        }

        /* Video Container */
        .video-container {
            display: none;
            position: relative;
            background: #000;
            border-radius: var(--radius);
            overflow: hidden;
            margin-top: 20px;
        }

        .video-container.active {
            display: block;
        }

        #mainVideo {
            width: 100%;
            height: auto;
            min-height: 300px;
            object-fit: contain;
            border-radius: var(--radius);
        }

        /* Status Panel */
        .status-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 16px;
            backdrop-filter: blur(8px);
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .status-row:last-child {
            margin-bottom: 0;
        }

        .status-label {
            color: var(--muted);
            font-size: 12px;
            font-weight: 600;
        }

        .status-value {
            color: var(--text);
            font-weight: 600;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.connected {
            background: #00ff88;
            box-shadow: 0 0 8px rgba(0, 255, 136, 0.5);
        }

        .status-indicator.disconnected {
            background: #ff4757;
            box-shadow: 0 0 8px rgba(255, 71, 87, 0.5);
        }

        /* Participants List */
        .participants-list {
            margin-top: 12px;
        }

        .participant {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .participant:last-child {
            border-bottom: none;
        }

        .participant-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-weight: 600;
            color: var(--text);
        }

        .participant-role {
            font-size: 11px;
            color: var(--muted);
        }

        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-elev);
            color: var(--text);
            font-weight: 600;
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: 1050; /* Encima del modal */
            backdrop-filter: blur(10px);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 12, 0.7);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-elev);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-family: 'Staatliches', sans-serif;
            font-size: 24px;
            margin: 0;
        }

        .modal-body .input-group {
            margin-bottom: 16px;
        }

        .modal-footer {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-bar {
                grid-template-columns: 1fr;
                justify-items: center;
            }
            .brand {
                grid-row: 1;
                justify-content: center;
                text-align: center;
            }
            .brand h1 {
                font-size: clamp(28px, 8vw, 36px);
            }
            .right-controls {
                grid-row: 2;
            }
            #connectionText {
                display: none;
            }
            .chip {
                padding: 8px;
            }

            .grid.two {
                grid-template-columns: 1fr;
            }

            .controls {
                grid-template-columns: 1fr 1fr;
            }

            .mode-line .btn span {
                display: none;
            }
            .mode-line .btn {
                padding: 12px;
                width: 50px;
                height: 50px;
                font-size: 1.2em;
            }

            .modal-footer {
                flex-direction: column;
            }

            .modal-footer .btn {
                width: 100%;
            }
        }

        /* Animation entrada */
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Background decoration */
        .bg-decor {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
            background: radial-gradient(600px circle at var(--mouse-x, 50%) var(--mouse-y, 50%), rgba(108, 92, 231, 0.1), transparent 40%);
        }
    </style>
</head>
<body>
    <div class="bg-decor"></div>
    
    <header class="app fade-in">
        <div class="container app-bar">
            <div class="brand">
                <div>
                    <div style="display:flex; align-items:center; justify-content:center; gap:8px; flex-wrap:wrap;">
                        <h1>GameOver</h1>
                        <div class="product-badge">WATCH PARTY</div>
                    </div>
                    <div class="sub">Compartir recuerdos, crear momentos</div>
                </div>
            </div>

            <div class="right-controls">
                <div class="chip" id="connectionChip">
                    <div class="status-indicator disconnected" id="statusIndicator"></div>
                    <span id="connectionText">Desconectado</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container fade-in" style="animation-delay: 0.2s;">
        <!-- Connection Setup -->
        <section class="card" id="setupCard">
            <div class="mode-line">
                <div>
                    <h2 class="mode-title">Configurar Sesión</h2>
                    <div class="mode-sub">Crea una sala o únete a una existente</div>
                </div>
            </div>

            <div class="connection-form">
                <div class="grid two">
                    <div class="input-group">
                        <label class="input-label" for="roomCode">Código de Sala</label>
                        <input type="text" id="roomCode" placeholder="Crea una sala para obtener un código">
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="playerName">Tu Nombre</label>
                        <input type="text" id="playerName" placeholder="Jugador1" maxlength="20">
                    </div>
                </div>

                <div class="input-group" id="videoUploadSection">
                    <label class="input-label" for="videoFile">Video para compartir (solo Host)</label>
                    <input type="file" id="videoFile" accept="video/*">
                    <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
                        El host carga el video. Cualquiera puede controlar la reproducción.
                    </div>
                </div>

                <div class="controls">
                    <button class="btn" id="createRoomBtn">
                        <i class="fas fa-plus"></i>
                        Crear Sala (Host)
                    </button>
                    <button class="btn secondary" id="joinRoomBtn">
                        <i class="fas fa-sign-in-alt"></i>
                        Unirse
                    </button>
                </div>

                <div id="setupStatus" style="text-align: center; color: var(--muted); margin-top: 16px;"></div>
            </div>
        </section>

        <!-- Main Video Area -->
        <section class="card" id="videoCard" style="display: none;">
            <div class="mode-line">
                <div>
                    <h2 class="mode-title" id="sessionTitle">Sala: ...</h2>
                    <div class="mode-sub" id="sessionSub">Disfrutando juntos</div>
                </div>
                <div style="display:flex; flex-wrap: wrap; gap: 12px;">
                    <button class="btn secondary" id="muteBtn" title="Activar/Silenciar Micrófono">
                        <i class="fas fa-microphone"></i>
                        <span class="btn-text-desktop">Silenciar</span>
                    </button>
                    <button class="btn secondary" id="shareRoomBtn" style="display: none;" title="Invitar a más gente">
                        <i class="fas fa-share-alt"></i>
                        <span class="btn-text-desktop">Invitar</span>
                    </button>
                    <button class="btn secondary" id="leaveRoomBtn" title="Salir de la sala">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="btn-text-desktop">Salir</span>
                    </button>
                </div>
            </div>

            <div class="video-container" id="videoContainer">
                <video id="mainVideo" controls></video>
            </div>
        </section>

        <!-- Status Panel -->
        <section class="card" id="statusCard" style="display: none;">
            <div class="status-panel">
                <div class="status-row">
                    <span class="status-label">Estado de Conexión</span>
                    <span class="status-value" id="connectionStatus">Desconectado</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Rol</span>
                    <span class="status-value" id="userRole">-</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Participantes</span>
                    <span class="status-value" id="participantCount">0</span>
                </div>
            </div>

            <div class="participants-list" id="participantsList">
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px; font-weight: 600;">
                    PARTICIPANTES CONECTADOS
                </div>
                <div id="participantsContainer"></div>
            </div>
        </section>
    </main>

    <div class="toast" id="toast"></div>
    <div id="audioContainer" style="display: none;"></div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">¡Sala Creada! Comparte el Enlace</h3>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Enlace de invitación</label>
                    <input type="text" class="share-link-input" id="shareLinkInput" readonly>
                </div>
                <p style="font-size: 12px; color: var(--muted); margin-top: 8px;">Cualquiera con este enlace podrá unirse a la sala.</p>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" id="copyLinkBtn"><i class="fas fa-copy"></i> Copiar Enlace</button>
                <button class="btn" id="shareBtn"><i class="fas fa-share-alt"></i> Compartir</button>
                <button class="btn" id="closeModalBtn" style="background: var(--accent-2)">¡Entendido!</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
    <script>
        // === ESTADO GLOBAL ===
        let peer;
        let isHost = false;
        let roomCode = '';
        let playerName = '';
        let videoFile = null;
        let localAudioStream = null;
        let connections = new Map(); // Clave: peerId, Valor: { conn, name, isHost, peerId }
        let calls = new Map(); // Clave: peerId, Valor: la llamada de PeerJS
        let isVideoSyncing = false; // Flag para evitar bucles de sincronización

        // === ELEMENTOS DOM ===
        const elements = {
            roomCode: document.getElementById('roomCode'),
            playerName: document.getElementById('playerName'),
            videoFile: document.getElementById('videoFile'),
            videoUploadSection: document.getElementById('videoUploadSection'),
            createRoomBtn: document.getElementById('createRoomBtn'),
            joinRoomBtn: document.getElementById('joinRoomBtn'),
            setupStatus: document.getElementById('setupStatus'),
            setupCard: document.getElementById('setupCard'),
            videoCard: document.getElementById('videoCard'),
            videoContainer: document.getElementById('videoContainer'),
            mainVideo: document.getElementById('mainVideo'),
            sessionTitle: document.getElementById('sessionTitle'),
            leaveRoomBtn: document.getElementById('leaveRoomBtn'),
            shareRoomBtn: document.getElementById('shareRoomBtn'),
            muteBtn: document.getElementById('muteBtn'),
            statusCard: document.getElementById('statusCard'),
            statusIndicator: document.getElementById('statusIndicator'),
            connectionText: document.getElementById('connectionText'),
            connectionStatus: document.getElementById('connectionStatus'),
            userRole: document.getElementById('userRole'),
            participantCount: document.getElementById('participantCount'),
            participantsContainer: document.getElementById('participantsContainer'),
            audioContainer: document.getElementById('audioContainer'),
            toast: document.getElementById('toast'),
            shareModal: document.getElementById('shareModal'),
            shareLinkInput: document.getElementById('shareLinkInput'),
            copyLinkBtn: document.getElementById('copyLinkBtn'),
            shareBtn: document.getElementById('shareBtn'),
            closeModalBtn: document.getElementById('closeModalBtn')
        };

        // === FUNCIONES AUXILIARES ===
        function showToast(message, type = 'info') {
            elements.toast.textContent = message;
            elements.toast.style.borderLeft = type === 'error' ? '4px solid #ff4757' : '4px solid #6c5ce7';
            elements.toast.classList.add('show');
            setTimeout(() => elements.toast.classList.remove('show'), 3500);
        }

        function setSetupStatus(message, isLoading = false) {
            elements.setupStatus.innerHTML = isLoading 
                ? `<div class="loading-spinner"></div><span style="margin-left: 8px;">${message}</span>` 
                : message;
        }

        function updateConnectionStatus(status, text) {
            elements.statusIndicator.className = `status-indicator ${status}`;
            elements.connectionText.textContent = text;
            elements.connectionStatus.textContent = text;
        }

        function getSerializableParticipants() {
            const serializable = [];
            for (const [peerId, data] of connections.entries()) {
                serializable.push([peerId, {
                    name: data.name,
                    isHost: data.isHost,
                    peerId: data.peerId
                }]);
            }
            return serializable;
        }

        function updateParticipantsList() {
            const container = elements.participantsContainer;
            container.innerHTML = '';
            connections.forEach(p => {
                const participantEl = document.createElement('div');
                participantEl.className = 'participant';
                participantEl.innerHTML = `
                    <div class="participant-avatar">${p.name.charAt(0).toUpperCase()}</div>
                    <div class="participant-info">
                        <div class="participant-name">${p.name} ${p.peerId === (peer ? peer.id : '') ? '(Tú)' : ''}</div>
                        <div class="participant-role">${p.isHost ? 'Host' : 'Invitado'}</div>
                    </div>`;
                container.appendChild(participantEl);
            });
            elements.participantCount.textContent = connections.size;
        }

        function switchToVideoView() {
            elements.setupCard.style.display = 'none';
            elements.videoCard.style.display = 'block';
            elements.statusCard.style.display = 'block';
            elements.videoContainer.classList.add('active');
            elements.sessionTitle.textContent = `Sala: ${roomCode}`;
            elements.userRole.textContent = isHost ? 'Host' : 'Invitado';
            if (isHost) {
                elements.shareRoomBtn.style.display = 'inline-flex';
            }
        }
        
        function generateShareLink(id) {
            const url = new URL(window.location.href);
            url.searchParams.set('room', id);
            return url.toString();
        }

        function showShareModal() {
            const shareLink = generateShareLink(peer.id);
            elements.shareLinkInput.value = shareLink;
            elements.shareModal.classList.add('show');
            elements.shareLinkInput.focus();
            elements.shareLinkInput.select();
        }

        async function initializeAudio() {
            try {
                localAudioStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                elements.muteBtn.querySelector('.btn-text-desktop').textContent = 'Silenciar';
                elements.muteBtn.querySelector('i').className = 'fas fa-microphone';
                return true;
            } catch (err) {
                showToast('No se pudo acceder al micrófono.', 'error');
                console.error('Error al obtener audio:', err);
                return false;
            }
        }

        // === LÓGICA DE COMUNICACIÓN (PEERJS) ===

        function broadcastToAll(data) {
            connections.forEach(p => {
                if (p.conn && p.conn.open) {
                    p.conn.send(data);
                }
            });
        }

        async function handleIncomingData(data, conn) {
            console.log('Datos recibidos:', data);
            switch (data.type) {
                case 'video-state-update':
                    isVideoSyncing = true;
                    elements.mainVideo.currentTime = data.currentTime;
                    data.isPlaying ? elements.mainVideo.play() : elements.mainVideo.pause();
                    break;
                case 'participant-update':
                    const newParticipants = new Map(data.participants);
                    if (localAudioStream) {
                        newParticipants.forEach(p => {
                            if (!connections.has(p.peerId) && p.peerId !== peer.id) {
                                console.log(`Detectado nuevo usuario ${p.name}, iniciando llamada.`);
                                const call = peer.call(p.peerId, localAudioStream);
                                if (call) setupCallListeners(call);
                            }
                        });
                    }
                    connections = newParticipants;
                    updateParticipantsList();
                    break;
                case 'initial-sync-request':
                     if (isHost) {
                        if (conn) {
                            const videoBuffer = await videoFile.arrayBuffer();
                            conn.send({
                                type: 'initial-sync-response',
                                participants: getSerializableParticipants(),
                                video: {
                                    buffer: videoBuffer,
                                    type: videoFile.type,
                                    currentTime: elements.mainVideo.currentTime,
                                    isPlaying: !elements.mainVideo.paused
                                }
                            });
                        }
                    }
                    break;
            }
        }

        function setupCallListeners(call) {
            call.on('stream', (remoteStream) => {
                console.log('Recibiendo stream de audio de:', call.peer);
                if (document.getElementById(`audio-${call.peer}`)) return; // Evitar duplicados
                const audioEl = document.createElement('audio');
                audioEl.srcObject = remoteStream;
                audioEl.autoplay = true;
                audioEl.id = `audio-${call.peer}`;
                elements.audioContainer.appendChild(audioEl);
            });

            call.on('close', () => {
                document.getElementById(`audio-${call.peer}`)?.remove();
                calls.delete(call.peer);
            });
            
            call.on('error', (err) => {
                console.error('Error en llamada de PeerJS:', err);
                showToast(`Error de audio con ${call.peer}`, 'error');
            });

            calls.set(call.peer, call);
        }

        function setupConnectionListeners(conn) {
            conn.on('data', (data) => handleIncomingData(data, conn));

            conn.on('open', () => {
                console.log(`Conexión establecida con: ${conn.peer}`);
                if (isHost) {
                    connections.set(conn.peer, { conn, name: conn.metadata.name, isHost: false, peerId: conn.peer });
                    broadcastToAll({ type: 'participant-update', participants: getSerializableParticipants() });
                    updateParticipantsList();
                    showToast(`${conn.metadata.name} se ha unido.`);
                }
            });

            conn.on('close', () => {
                const disconnectedUser = connections.get(conn.peer);
                if (disconnectedUser) {
                    showToast(`${disconnectedUser.name} se ha desconectado.`);
                    connections.delete(conn.peer);
                    calls.get(conn.peer)?.close();
                    document.getElementById(`audio-${conn.peer}`)?.remove();
                    broadcastToAll({ type: 'participant-update', participants: getSerializableParticipants() });
                    updateParticipantsList();
                }
            });
            
            conn.on('error', (err) => {
                console.error('Error en la conexión PeerJS:', err);
                showToast(`Error de conexión con ${conn.peer}`, 'error');
            });
        }

        // === FUNCIONES DE SALA ===

        async function startHostSession() {
            playerName = elements.playerName.value.trim();
            videoFile = elements.videoFile.files[0];

            if (!playerName || !videoFile) {
                showToast('Debes elegir un nombre y un archivo de video.', 'error');
                return;
            }
            
            setSetupStatus('Iniciando audio...', true);
            if (!await initializeAudio()) {
                setSetupStatus('Acceso al micrófono denegado.', false);
                return;
            }

            setSetupStatus('Creando sala en la red PeerJS...', true);
            isHost = true;
            peer = new Peer();

            peer.on('open', (id) => {
                roomCode = id;
                console.log('Host iniciado con ID:', id);
                setSetupStatus('');
                showShareModal();
                elements.createRoomBtn.disabled = true;
                elements.joinRoomBtn.disabled = true;
                connections.set(peer.id, { conn: null, name: playerName, isHost: true, peerId: peer.id });
                updateParticipantsList();
                elements.mainVideo.src = URL.createObjectURL(videoFile);
                elements.mainVideo.load();
                updateConnectionStatus('connected', 'Conectado como Host');
            });

            peer.on('connection', (conn) => {
                console.log(`Recibida conexión de datos de ${conn.peer}`);
                setupConnectionListeners(conn);
            });

            peer.on('call', (call) => {
                console.log(`Recibida llamada de audio de ${call.peer}`);
                call.answer(localAudioStream);
                setupCallListeners(call);
            });
            
            peer.on('error', (err) => {
                console.error('Error de PeerJS:', err);
                setSetupStatus(`Error al crear la sala: ${err.message}`, false);
                showToast(`Error de PeerJS: ${err.type}`, 'error');
            });
        }

        async function joinGuestSession() {
            playerName = elements.playerName.value.trim();
            roomCode = elements.roomCode.value.trim();

            if (!playerName || !roomCode) {
                showToast('Debes usar un nombre y un código de sala.', 'error');
                return;
            }

            setSetupStatus('Iniciando audio...', true);
            if (!await initializeAudio()) {
                setSetupStatus('Acceso al micrófono denegado.', false);
                return;
            }

            setSetupStatus(`Conectando a la sala ${roomCode}...`, true);
            isHost = false;
            peer = new Peer();

            peer.on('open', () => {
                console.log('Cliente PeerJS iniciado con ID:', peer.id);
                const dataConn = peer.connect(roomCode, { metadata: { name: playerName }, reliable: true });
                setupConnectionListeners(dataConn);

                dataConn.on('open', () => {
                    setSetupStatus('');
                    updateConnectionStatus('connected', 'Conectado a la sala');
                    showToast(`¡Conectado! Sincronizando...`);
                    dataConn.send({ type: 'initial-sync-request', peerId: peer.id });
                });

                 dataConn.on('data', (data) => {
                    if (data.type === 'initial-sync-response') {
                        const videoData = data.video;
                        const videoBlob = new Blob([videoData.buffer], { type: videoData.type });
                        elements.mainVideo.src = URL.createObjectURL(videoBlob);
                        elements.mainVideo.load();
                        elements.mainVideo.currentTime = videoData.currentTime;
                        if (videoData.isPlaying) elements.mainVideo.play();

                        const initialParticipants = new Map(data.participants);
                        initialParticipants.forEach(p => {
                            if (p.peerId !== peer.id && p.peerId !== roomCode) { // No llamar al host (ya lo haremos) ni a si mismo
                                const call = peer.call(p.peerId, localAudioStream);
                                if(call) setupCallListeners(call);
                            }
                        });
                        const hostCall = peer.call(roomCode, localAudioStream);
                        if(hostCall) setupCallListeners(hostCall);

                        connections = initialParticipants;
                        connections.set(peer.id, { conn: dataConn, name: playerName, isHost: false, peerId: peer.id });
                        updateParticipantsList();
                        switchToVideoView();
                    } else {
                        handleIncomingData(data, dataConn);
                    }
                });
            });

            peer.on('call', (call) => {
                console.log(`Recibida llamada de audio de ${call.peer}`);
                call.answer(localAudioStream);
                setupCallListeners(call);
            });
            
            peer.on('error', (err) => {
                console.error('Error de PeerJS:', err);
                setSetupStatus(`Error al unirse: ${err.message}`, false);
                showToast(`Error de PeerJS: ${err.type}`, 'error');
            });
        }

        function leaveRoom() {
            if (peer) peer.destroy();
            connections.clear();
            calls.clear();
            if(localAudioStream) localAudioStream.getTracks().forEach(track => track.stop());
            const video = elements.mainVideo;
            if (video.src) URL.revokeObjectURL(video.src);
            video.src = '';
            if (videoFile) videoFile = null;
            window.history.pushState({}, document.title, window.location.pathname);
            location.reload();
        }

        // === CONTROLES DE VIDEO Y AUDIO ===
        function syncVideoState() {
            if (!peer || connections.size < 1) return;
            console.log('Enviando estado de video');
            broadcastToAll({
                type: 'video-state-update',
                currentTime: elements.mainVideo.currentTime,
                isPlaying: !elements.mainVideo.paused
            });
        }

        function toggleMute() {
            if (!localAudioStream) return;
            const audioTrack = localAudioStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                const isMuted = !audioTrack.enabled;
                elements.muteBtn.querySelector('.btn-text-desktop').textContent = isMuted ? 'Activar Voz' : 'Silenciar';
                elements.muteBtn.querySelector('i').className = isMuted ? 'fas fa-microphone-slash' : 'fas fa-microphone';
                showToast(isMuted ? 'Micrófono silenciado' : 'Micrófono activado');
            }
        }

        // === EVENT LISTENERS ===
        elements.createRoomBtn.addEventListener('click', startHostSession);
        elements.joinRoomBtn.addEventListener('click', joinGuestSession);
        elements.leaveRoomBtn.addEventListener('click', leaveRoom);
        elements.shareRoomBtn.addEventListener('click', showShareModal);
        elements.muteBtn.addEventListener('click', toggleMute);

        elements.mainVideo.addEventListener('play', () => {
            if (isVideoSyncing) { isVideoSyncing = false; return; }
            syncVideoState();
        });
        elements.mainVideo.addEventListener('pause', () => {
            if (isVideoSyncing) { isVideoSyncing = false; return; }
            syncVideoState();
        });
        elements.mainVideo.addEventListener('seeked', () => {
            if (isVideoSyncing) { isVideoSyncing = false; return; }
            syncVideoState();
        });

        elements.closeModalBtn.addEventListener('click', () => {
            elements.shareModal.classList.remove('show');
            switchToVideoView();
        });

        elements.copyLinkBtn.addEventListener('click', () => {
            elements.shareLinkInput.select();
            navigator.clipboard.writeText(elements.shareLinkInput.value);
            showToast('Enlace copiado al portapapeles');
        });

        elements.shareBtn.addEventListener('click', async () => {
            const shareData = {
                title: 'Invitación a Watch Party de GameOver',
                text: `¡Únete a mi sala para ver un video juntos!`,
                url: elements.shareLinkInput.value
            };
            if (navigator.share && navigator.canShare(shareData)) {
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    console.error('Error al compartir:', err);
                }
            } else {
                showToast('La función de compartir no está disponible en este navegador. ¡Copia el enlace!');
                elements.copyLinkBtn.click();
            }
        });

        // === INICIALIZACIÓN ===
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof Peer === 'undefined') {
                setSetupStatus('Error: La librería de conexión no pudo cargarse.', false);
                showToast('Revisa tu conexión a internet o desactiva tu bloqueador de anuncios.', 'error');
                elements.createRoomBtn.disabled = true;
                elements.joinRoomBtn.disabled = true;
                return;
            }

            elements.playerName.value = `Player${Math.floor(Math.random() * 999)}`;

            const urlParams = new URLSearchParams(window.location.search);
            const roomFromUrl = urlParams.get('room');
            if (roomFromUrl) {
                elements.roomCode.value = roomFromUrl;
                elements.roomCode.readOnly = true;
                elements.videoUploadSection.style.display = 'none';
                elements.createRoomBtn.style.display = 'none';
                elements.joinRoomBtn.style.gridColumn = '1 / -1';
                showToast('Uniéndote a una sala desde un enlace.');
            } else {
                 elements.joinRoomBtn.disabled = true;
                 elements.roomCode.disabled = true;
            }

            document.addEventListener('mousemove', (e) => {
                document.querySelector('.bg-decor').style.setProperty('--mouse-x', (e.clientX / window.innerWidth) * 100 + '%');
                document.querySelector('.bg-decor').style.setProperty('--mouse-y', (e.clientY / window.innerHeight) * 100 + '%');
            });

            console.log('GameOver Watch Party v2.5 (Final) inicializado.');
        });

        window.addEventListener('beforeunload', () => {
            if (peer) peer.destroy();
        });
    </script>
</body>
</html>