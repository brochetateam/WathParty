<!DOCTYPE html>
<html lang="es" data-theme="switch-light" data-palette="switch">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GameOver · Watch Party</title>

  <!-- PWA -->
  <meta name="theme-color" content="#ffffff" id="meta-theme-color">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png" sizes="180x180">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Staatliches&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    /* Reset + tokens */
    *, *::before, *::after { box-sizing: border-box; }
    :root {
      --radius: 12px;
      --shadow-1: 0 10px 30px rgba(0,0,0,.12);
      --focus: 0 0 0 3px var(--focus-ring);
      --font-sans: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --font-display: 'Staatliches', 'Poppins', sans-serif;
      /* Tamaño mascota: ajusta aquí */
      --mascot-size: clamp(80px, 12vw, 120px);
    }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: var(--font-sans);
      color: var(--text);
      background: var(--bg);
      line-height: 1.4;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      transition: background 240ms ease, color 200ms ease;
    }
    h1, h2 { font-family: var(--font-display); letter-spacing: .5px; margin: 0; }
    a { color: inherit; text-decoration: none; }

    /* Paletas (acento A/B) */
    :root[data-palette="switch"]  { --accentA: #ff3c28; --accentB: #00b5e0; }
    :root[data-palette="mario"]   { --accentA: #e52521; --accentB: #3b5cad; }
    :root[data-palette="zelda"]   { --accentA: #0f7a0d; --accentB: #c7a008; }
    :root[data-palette="kirby"]   { --accentA: #ff77aa; --accentB: #ffd1e6; }
    :root[data-palette="metroid"] { --accentA: #ff6b00; --accentB: #00ffc3; }
    :root[data-palette="ink"]     { --accentA: #7fe000; --accentB: #ff2bb3; }

    /* Temas (claro/oscuro) usa acentos de la paleta */
    :root[data-theme="switch-light"] {
      --bg: linear-gradient(180deg, #ffffff 0%, #f6f7fb 100%) fixed;
      --surface: #ffffff; --surface-2: #f2f4f8;
      --text: #0f172a; --muted: #64748b; --border: #e5e7eb;
      --btn-text: #ffffff; --focus-ring: rgba(0,181,224,.35);
      --video-bg: #0b1220; --header-grad: linear-gradient(90deg, var(--accentA), var(--accentB));
      --chip-bg: rgba(0, 181, 224, .12); --chip-border: rgba(0, 181, 224, .35);
    }
    :root[data-theme="switch-dark"] {
      --bg: linear-gradient(180deg, #0f1115 0%, #0b0d12 100%) fixed;
      --surface: #171a21; --surface-2: #1b1f27;
      --text: #e8eaf2; --muted: #9aa3b2; --border: #2a2f3b;
      --btn-text: #0b0d12; --focus-ring: rgba(0,181,224,.35);
      --video-bg: #000000; --header-grad: linear-gradient(90deg, var(--accentA), var(--accentB));
      --chip-bg: rgba(0, 181, 224, .15); --chip-border: rgba(0, 181, 224, .45);
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: .01ms !important; animation-iteration-count: 1 !important; transition-duration: .01ms !important; }
      .fade-in { opacity: 1 !important; transform: none !important; }
    }

    .container { max-width: 1000px; margin: 0 auto; padding: 16px; }
    header.app { position: relative; padding: 16px 0 8px; }

    /* Header (estructura template) */
    .app-bar { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 12px; position: relative; }
    .brand { display: flex; align-items: center; gap: 14px; }
    .brand h1 {
      font-size: clamp(24px, 4.2vw, 36px);
      line-height: 1;
      background: var(--header-grad);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      text-shadow: 0 2px 30px rgba(0,0,0,.1);
    }
    .product-badge {
      margin-left: 8px; padding: 6px 12px; border-radius: 999px;
      font-weight: 800; letter-spacing: 1px; font-size: 13px; color: #fff;
      background: linear-gradient(180deg, var(--accentA), color-mix(in srgb, var(--accentA) 60%, white));
      box-shadow: 0 8px 18px -6px color-mix(in srgb, var(--accentA) 60%, transparent);
    }
    .product-badge.product-mobile { display: none; }
    .sub { font-size: 12px; color: var(--muted); margin-top: 4px; }

    .right-controls { display: flex; align-items: center; gap: 8px; }
    .right-actions-row { display: flex; gap: 8px; align-items: center; }

    .chip {
      display: inline-flex; align-items: center; gap: 6px; border-radius: 999px; padding: 8px 12px;
      background: var(--chip-bg); border: 1px solid var(--chip-border); color: var(--text);
      backdrop-filter: blur(6px); font-weight: 700;
    }
    .status-indicator { width: 10px; height: 10px; border-radius: 50%; background: #ef4444; }
    .status-indicator.connected { background: #22c55e; }

    .icon-btn {
      border: 1px solid var(--border); border-radius: 999px; background: var(--surface); color: var(--text);
      padding: 10px; width: 44px; height: 44px; display: inline-grid; place-items: center; cursor: pointer;
      transition: transform 120ms ease, filter 140ms ease; box-shadow: var(--shadow-1); backdrop-filter: blur(6px);
    }
    .icon-btn:hover { transform: translateY(-2px); filter: brightness(1.06); }

    /* Mascota monitor */
    .mascot-hero { width: var(--mascot-size); height: var(--mascot-size); cursor: pointer; }
    .mascot-hero svg { width: 100%; height: 100%; overflow: visible; }
    .eye-group { transition: transform 0.2s ease-out; }
    .eye-lid {
      transform-origin: center;
      transform-box: fill-box;
      animation: blink 6s infinite;
    }
    @keyframes blink { 0%, 97%, 100% { transform: scaleY(1); } 98%, 99% { transform: scaleY(0.1); } }
    .wink .eye--left .eye-lid { animation: wink-animation 0.5s; }
    .wink .eye--right .eye-lid { animation: none; }
    @keyframes wink-animation { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(0.1); } }
    .mouth--smile { display: none; }
    .smile .mouth--normal { display: none; }
    .smile .mouth--smile { display: block; }

    /* Cards / Forms / Buttons */
    .card { position: relative; margin: 16px auto 20px; padding: clamp(14px, 3vw, 20px); background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow-1); }
    .mode-line { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 12px; }
    .mode-title { font-size: clamp(18px, 4.3vw, 28px); }
    .mode-sub { color: var(--muted); font-size: 14px; margin-top: 4px; }

    .connection-form { display: grid; gap: 16px; margin-bottom: 10px; }
    .grid { display: grid; gap: 12px; }
    .grid.two { grid-template-columns: 1fr 1fr; }

    label.input-label { font-size: 12px; color: var(--muted); font-weight: 700; }
    input[type="text"], input[type="file"], .share-link-input {
      width: 100%; border-radius: 10px; border: 1px solid var(--border);
      background: var(--surface-2); padding: 12px 14px; font-size: 15px; color: var(--text);
      outline: none; font-family: var(--font-sans); transition: border-color 140ms ease, box-shadow 140ms ease, background 140ms ease;
    }
    input[type="text"]:focus, input[type="file"]:focus, .share-link-input:focus { border-color: var(--accentB); box-shadow: var(--focus); }
    .share-link-input { background: var(--surface); font-weight: 600; }

    input[type="file"]::file-selector-button {
      background: linear-gradient(180deg, var(--accentA), color-mix(in srgb, var(--accentA) 60%, white));
      color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 800; margin-right: 12px;
    }

    button.btn {
      border: 0; border-radius: 10px; padding: 12px 18px; font-weight: 800; font-size: 14px; cursor: pointer;
      color: var(--btn-text);
      background: linear-gradient(180deg, var(--accentA), color-mix(in srgb, var(--accentA) 60%, white));
      box-shadow: 0 10px 18px -10px color-mix(in srgb, var(--accentA) 50%, transparent), 0 2px 0 0 rgba(0,0,0,.06);
      display: inline-flex; align-items: center; gap: 10px; min-height: 44px; transition: transform 100ms ease, filter 140ms ease;
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.04); }
    .btn.secondary { background: var(--surface-2); color: var(--text); border: 1px solid var(--border); box-shadow: var(--shadow-1); }

    .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }

    /* Vídeo */
    .video-container { display: none; position: relative; background: var(--video-bg); border-radius: 12px; overflow: hidden; margin-top: 12px; box-shadow: var(--shadow-1); }
    .video-container.active { display: block; }
    #mainVideo { width: 100%; height: auto; min-height: 300px; object-fit: contain; background: #000; }

    /* Modo CINE */
    .px-fab {
      position: absolute; right: 12px; top: 12px; z-index: 10;
      border: 0; border-radius: 10px; color: #fff;
      background: linear-gradient(180deg, var(--accentB), color-mix(in srgb, var(--accentB) 65%, white));
      padding: 10px 12px; font-weight: 900; display: inline-flex; align-items: center; gap: 8px;
      box-shadow: 0 10px 18px -10px color-mix(in srgb, var(--accentB) 50%, transparent);
      cursor: pointer; transition: transform 100ms ease, filter 120ms ease;
    }
    .px-fab:hover { transform: translateY(-1px); filter: brightness(1.04); }
    
    body.cinema-mode header, body.cinema-mode main > *:not(#videoCard), body.cinema-mode footer {
      display: none;
    }
    body.cinema-mode main.container { max-width: 100%; padding: 0; }
    body.cinema-mode #videoCard { margin: 0; padding: 0; border: 0; border-radius: 0; }
    body.cinema-mode .video-container { border-radius: 0; }

    /* Status / Participantes */
    .status-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-top: 8px; box-shadow: var(--shadow-1); }
    .status-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .status-label { color: var(--muted); font-size: 12px; font-weight: 800; }
    .status-value { color: var(--text); font-weight: 800; }

    .participants-list { margin-top: 12px; }
    .participant { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
    .participant:last-child { border-bottom: none; }
    .participant-avatar {
      width: 36px; height: 36px; border-radius: 8px; color: #fff; font-weight: 800; font-size: 13px; display: grid; place-items: center;
      background: linear-gradient(180deg, var(--accentB), color-mix(in srgb, var(--accentB) 65%, white));
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.18);
    }
    .participant-name { font-weight: 800; color: var(--text); }
    .participant-role { font-size: 11px; color: var(--muted); }

    /* Toast */
    .toast {
      position: fixed; bottom: 20px; right: 20px; background: var(--surface);
      border: 1px solid var(--border); padding: 12px 20px; border-radius: 12px;
      box-shadow: var(--shadow-1); color: var(--text); font-weight: 800;
      transform: translateX(120%); opacity: 0; transition: all .4s cubic-bezier(.25,1,.5,1); z-index: 1050;
    }
    .toast.show { transform: translateX(0); opacity: 1; }

    /* Modales */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.55); backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center; z-index: 1000;
      opacity: 0; visibility: hidden; transition: opacity .24s ease, visibility .24s ease; }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    .modal-content { background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
      padding: 20px; width: 92%; max-width: 560px; box-shadow: var(--shadow-1);
      transform: translateY(8px); transition: transform .24s ease; }
    .modal-overlay.show .modal-content { transform: translateY(0); }
    .modal-header, .modal-footer { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
    .modal-title { font-family: var(--font-display); font-size: 24px; margin: 0; }
    .modal-body .input-group { margin: 12px 0; }

    /* Footer */
    footer { padding: 12px 0 24px; text-align: center; color: var(--muted); font-size: 13px; }
    .cta-row { display: flex; justify-content: center; margin-bottom: 10px; }
    .glow-cta { border: 1px solid var(--border); border-radius: 12px; background: var(--surface); color: var(--text); padding: 10px 14px; font-weight: 800; cursor: pointer; box-shadow: var(--shadow-1); }

    /* Decor + entrada */
    .bg-decor { position: fixed; inset: 0; pointer-events: none; z-index: -1; background: radial-gradient(600px circle at var(--mouse-x, 50%) var(--mouse-y, 50%), color-mix(in srgb, var(--accentB) 25%, transparent), transparent 40%); }
    .fade-in { opacity: 0; transform: translateY(12px); animation: fadeInUp .5s ease forwards; }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0) } }

    /* Responsive */
    @media (max-width: 640px) {
      .brand { align-items: flex-start; }
      .brand h1 { font-size: clamp(20px, 7vw, 28px); }
      .product-badge { display: none; }
      .product-badge.product-mobile { display: inline-block; font-size: 18px; padding: 6px 12px; margin: 6px 0 0; }
      .right-controls { position: absolute; top: 6px; right: 10px; gap: 6px; }
      #connectionText { display: none; } /* móvil: solo icono */
      .grid.two { grid-template-columns: 1fr; }
      .controls { grid-template-columns: 1fr 1fr; }
      .mode-line .btn span { display: none; }
      .mode-line .btn { padding: 12px; width: 52px; height: 52px; font-size: 1.2em; }
      .modal-footer { flex-direction: column; }
      .modal-footer .btn { width: 100%; }
    }
  </style>
</head>

<body>
  <div class="bg-decor"></div>

  <header class="app fade-in">
    <div class="container app-bar">
      <div class="brand">
        <!-- Mascota monitor (vuestra) -->
        <div class="mascot-hero" id="mascotHero" title="Monitor Buddy">
          <svg class="mascot" viewBox="0 0 64 64" aria-hidden="true">
            <rect x="6" y="10" width="52" height="40" rx="6" fill="#141820" stroke="url(#g1)" stroke-width="2"/>
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="var(--accentA)"/><stop offset="1" stop-color="var(--accentB)"/>
              </linearGradient>
            </defs>
            <rect x="10" y="14" width="44" height="28" rx="4" fill="#0a0f18" stroke="var(--accentB)" stroke-opacity="0.35"/>
            <g class="eye-group" id="eyes">
              <g class="eye eye--left"><circle class="eye-lid" cx="24" cy="28" r="3" fill="var(--accentB)"/></g>
              <g class="eye eye--right"><circle class="eye-lid" cx="40" cy="28" r="3" fill="var(--accentA)"/></g>
            </g>
            <path class="mouth mouth--normal" d="M26,38 L38,38" stroke="#8c95af" stroke-width="2" fill="none" stroke-linecap="round"/>
            <path class="mouth mouth--smile" d="M26,38 Q32,44 38,38" stroke="#8c95af" stroke-width="2" fill="none" stroke-linecap="round"/>
            <path d="M10,54 L54,54" stroke="var(--accentB)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>

        <div>
          <div style="display:flex; align-items:flex-start; gap:8px; flex-wrap:wrap;">
            <h1>GameOver</h1>
            <div class="product-badge" aria-label="Producto">WATCH PARTY</div>
          </div>
          <div class="sub">para gamers cinéfilos</div>
          <div class="product-badge product-mobile">WATCH PARTY</div>
        </div>
      </div>

      <!-- Acciones derecha -->
      <div class="right-controls">
        <div class="right-actions-row">
          <!-- Solo icono; cambia a sol/luna -->
          <button class="icon-btn" id="themeToggle" aria-label="Cambiar a tema oscuro" title="Cambiar tema">
            <i class="fa-solid fa-moon"></i>
          </button>
          <button class="icon-btn" id="installBtn" aria-label="Instalar app" style="display:none;">
            <i class="fa-solid fa-download"></i>
          </button>
        </div>
        <div class="chip" id="connectionChip" title="Estado de conexión">
          <div class="status-indicator" id="statusIndicator"></div>
          <strong id="connectionText">Desconectado</strong>
        </div>
      </div>
    </div>
  </header>

  <main class="container fade-in" style="animation-delay:.1s">
    <!-- Configuración -->
    <section class="card" id="setupCard">
      <div class="mode-line">
        <div>
          <h2 class="mode-title">Configurar Sesión</h2>
          <div class="mode-sub">Crea una sala</div>
        </div>
      </div>

      <div class="connection-form">
        <div class="grid two">
          <div class="input-group">
            <label class="input-label" for="playerName">Tu Nombre</label>
            <input type="text" id="playerName" placeholder="Jugador1" maxlength="20">
          </div>
          <div class="input-group" id="videoUploadSection">
            <label class="input-label" for="videoFile">Video para compartir</label>
            <input type="file" id="videoFile" accept="video/*">
          </div>
        </div>

        <div class="controls">
          <button class="btn" id="createRoomBtn">
            <i class="fas fa-plus"></i>
            <span>Crea Sala</span>
          </button>
          <button class="btn" id="joinRoomBtn" style="display: none;">
            <i class="fas fa-sign-in-alt"></i>
            <span>Unirse</span>
          </button>
        </div>

        <div id="setupStatus" style="text-align:center; color: var(--muted); margin-top:10px;"></div>
      </div>
    </section>

    <!-- Vídeo -->
    <section class="card" id="videoCard" style="display:none;">
      <div class="mode-line">
        <div>
          <h2 class="mode-title" id="sessionTitle">Sala: ...</h2>
          <div class="mode-sub" id="sessionSub">Disfrutando juntos</div>
        </div>
        <div style="display:flex; flex-wrap:wrap; gap:12px;">
          <button class="btn secondary" id="muteBtn" title="Activar/Silenciar Micrófono (M)">
            <i class="fas fa-microphone"></i>
            <span class="btn-text-desktop">Silenciar</span>
          </button>
          <button class="btn secondary" id="shareRoomBtn" style="display:none;" title="Invitar a más gente">
            <i class="fas fa-share-alt"></i>
            <span class="btn-text-desktop">Invitar</span>
          </button>
          <button class="btn secondary" id="leaveRoomBtn" title="Salir de la sala">
            <i class="fas fa-sign-out-alt"></i>
            <span class="btn-text-desktop">Salir</span>
          </button>
        </div>
      </div>

      <div class="video-container" id="videoContainer">
        <!-- CINE = Fullscreen; se oculta en fullscreen -->
        <button class="px-fab" id="fullscreenOverlayBtn" title="Pantalla completa (F)">
          <i class="fa-solid fa-clapperboard"></i> CINE
        </button>
        <video id="mainVideo" controls></video>
      </div>
    </section>

    <!-- Estado -->
    <section class="card" id="statusCard" style="display:none;">
      <div class="status-panel">
        <div class="status-row">
          <span class="status-label">Estado de Conexión</span>
          <span class="status-value" id="connectionStatus">Desconectado</span>
        </div>
        <div class="status-row">
          <span class="status-label">Rol</span>
          <span class="status-value" id="userRole">-</span>
        </div>
        <div class="status-row">
          <span class="status-label">Participantes</span>
          <span class="status-value" id="participantCount">0</span>
        </div>
      </div>

      <div class="participants-list" id="participantsList">
        <div style="font-size:12px; color:var(--muted); margin-bottom:8px; font-weight:800;">PARTICIPANTES CONECTADOS</div>
        <div id="participantsContainer"></div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast"></div>
  <div id="audioContainer" style="display:none;"></div>

  <!-- Share Modal (sin aspa, con ¡Entendido!) -->
  <div class="modal-overlay" id="shareModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">¡Sala Creada! Comparte el Enlace</h3>
      </div>
      <div class="modal-body">
        <div class="input-group">
          <label class="input-label">Enlace de invitación</label>
          <input type="text" class="share-link-input" id="shareLinkInput" readonly>
        </div>
        <p style="font-size:12px; color:var(--muted); margin-top:8px;">Cualquiera con este enlace podrá unirse a la sala.</p>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" id="copyLinkBtn"><i class="fas fa-copy"></i> Copiar Enlace</button>
        <button class="btn" id="shareBtn" style="background: linear-gradient(180deg, var(--accentB), color-mix(in srgb, var(--accentB) 65%, white))"><i class="fas fa-share-alt"></i> Compartir</button>
        <button class="btn" id="enterRoomBtn"><i class="fa-solid fa-check"></i> ¡Entendido!</button>
      </div>
    </div>
  </div>

  <!-- Manual Modal -->
  <div class="modal-overlay" id="manualModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Manual rápido</h3>
      </div>
      <div class="modal-body" style="display:grid; gap:12px;">
        <div>
          <strong>Crear sala</strong>
          <ul>
            <li>Escribe tu nombre.</li>
            <li>Selecciona un vídeo (se envía P2P a los invitados).</li>
            <li>Pulsa “Crear Sala ” y comparte el enlace.</li>
          </ul>
        </div>
        <div>
          <strong>Unirse desde enlace</strong>
          <ul>
            <li>Abre el enlace que te pase el host y se conectará automáticamente.</li>
            <li>Permite el micrófono para hablar con el equipo.</li>
          </ul>
        </div>
        <div>
          <strong>Controles</strong>
          <ul>
            <li>Espacio: Play/Pause sincronizado</li>
            <li>M: Silenciar/activar micrófono</li>
            <li>F: Pantalla completa (o botón CINE)</li>
          </ul>
        </div>
        <div>
          <strong>Notas</strong>
          <ul>
            <li>Todo es P2P con PeerJS, sin backend.</li>
            <li>El host debe mantener la pestaña abierta.</li>
            <li>Instala la app como PWA con el botón Instalar.</li>
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="manualOkBtn">¡Entendido!</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="cta-row">
      <button id="reglas-btn" class="glow-cta"><i class="fa-solid fa-book"></i> Manual</button>
    </div>
    Cine con estilo<br>Made with <span style="color:#ff3c91;">❤</span><br>© 2025 GameOver Studios<br>
  </footer>

  <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
  <script>
    // ===== Config rápida =====
    const DEFAULT_THEME = 'switch-light';   // 'switch-light' | 'switch-dark'
    const DEFAULT_PALETTE = 'switch';       // 'switch' | 'mario' | 'zelda' | 'kirby' | 'metroid' | 'ink'

    // ===== Estado global =====
    let peer, isHost = false, roomCode = '', playerName = '';
    let videoFile = null, localAudioStream = null;
    let connections = new Map(); // peerId -> { conn, name, isHost, peerId }
    let calls = new Map();
    let isVideoSyncing = false;
    let deferredPrompt = null;

    // ===== DOM =====
    const el = {
      playerName: document.getElementById('playerName'),
      videoFile: document.getElementById('videoFile'),
      createRoomBtn: document.getElementById('createRoomBtn'),
      joinRoomBtn: document.getElementById('joinRoomBtn'),
      setupStatus: document.getElementById('setupStatus'),
      setupCard: document.getElementById('setupCard'),
      videoCard: document.getElementById('videoCard'),
      videoContainer: document.getElementById('videoContainer'),
      mainVideo: document.getElementById('mainVideo'),
      sessionTitle: document.getElementById('sessionTitle'),
      leaveRoomBtn: document.getElementById('leaveRoomBtn'),
      shareRoomBtn: document.getElementById('shareRoomBtn'),
      muteBtn: document.getElementById('muteBtn'),
      statusCard: document.getElementById('statusCard'),
      statusIndicator: document.getElementById('statusIndicator'),
      connectionText: document.getElementById('connectionText'),
      connectionStatus: document.getElementById('connectionStatus'),
      userRole: document.getElementById('userRole'),
      participantCount: document.getElementById('participantCount'),
      participantsContainer: document.getElementById('participantsContainer'),
      audioContainer: document.getElementById('audioContainer'),
      toast: document.getElementById('toast'),
      shareModal: document.getElementById('shareModal'),
      shareLinkInput: document.getElementById('shareLinkInput'),
      copyLinkBtn: document.getElementById('copyLinkBtn'),
      shareBtn: document.getElementById('shareBtn'),
      enterRoomBtn: document.getElementById('enterRoomBtn'),
      themeToggle: document.getElementById('themeToggle'),
      installBtn: document.getElementById('installBtn'),
      fullscreenOverlayBtn: document.getElementById('fullscreenOverlayBtn'),
      manualModal: document.getElementById('manualModal'),
      manualOkBtn: document.getElementById('manualOkBtn'),
      manualBtn: document.getElementById('reglas-btn'),
      metaThemeColor: document.getElementById('meta-theme-color'),
      mascotHero: document.getElementById('mascotHero'),
      eyes: document.getElementById('eyes'),
    };

    // ===== Theme & Palette =====
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      const isDark = theme === 'switch-dark';
      el.metaThemeColor?.setAttribute('content', isDark ? '#0f1115' : '#ffffff');
      const icon = el.themeToggle?.querySelector('i');
      if (icon) icon.className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
      el.themeToggle?.setAttribute('aria-label', isDark ? 'Cambiar a tema claro' : 'Cambiar a tema oscuro');
    }
    function setPalette(name) {
      document.documentElement.setAttribute('data-palette', name);
      localStorage.setItem('palette', name);
    }
    function initThemeAndPalette() {
      const savedTheme = localStorage.getItem('theme') || DEFAULT_THEME;
      const savedPalette = localStorage.getItem('palette') || DEFAULT_PALETTE;
      // Forzamos un reapply para evitar el bug de primer render
      setPalette(savedPalette);
      requestAnimationFrame(() => setTheme(savedTheme));
    }
    el.themeToggle?.addEventListener('click', () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'switch-dark';
      setTheme(isDark ? 'switch-light' : 'switch-dark');
    });

    // ===== Mascota (ojos siguen + guiño + sonrisa) =====
    document.addEventListener('mousemove', (e) => {
      if (!el.mascotHero) return;
      const { clientX, clientY } = e;
      const rect = el.mascotHero.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;
      const dx = clientX - cx, dy = clientY - cy;
      const maxMove = 1.5;
      const moveX = (dx / (window.innerWidth / 2)) * maxMove;
      const moveY = (dy / (window.innerHeight / 2)) * maxMove;
      if (el.eyes) el.eyes.style.transform = `translate(${moveX}px, ${moveY}px)`;

      const decor = document.querySelector('.bg-decor');
      if (decor) {
        decor.style.setProperty('--mouse-x', (e.clientX / window.innerWidth) * 100 + '%');
        decor.style.setProperty('--mouse-y', (e.clientY / window.innerHeight) * 100 + '%');
      }
    });
    el.mascotHero?.addEventListener('click', () => {
      el.mascotHero.classList.add('wink');
      setTimeout(() => el.mascotHero.classList.remove('wink'), 500);
    });
    el.mascotHero?.addEventListener('dblclick', () => {
      el.mascotHero.classList.add('smile');
      setTimeout(() => el.mascotHero.classList.remove('smile'), 1000);
    });

    // ===== UI helpers =====
    function showToast(message, type='info') {
      el.toast.textContent = message;
      el.toast.style.borderLeft = type==='error' ? '4px solid #ef4444' : '4px solid var(--accentB)';
      el.toast.classList.add('show');
      setTimeout(()=>el.toast.classList.remove('show'), 3500);
    }
    function setSetupStatus(message, isLoading=false) {
      el.setupStatus.innerHTML = isLoading
        ? `<div class="loading-spinner" style="display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top:2px solid var(--accentB);border-radius:50%;animation:spin 1s linear infinite"></div><span style="margin-left: 8px;">${message}</span>`
        : message;
    }
    function updateConnectionStatus(status, text) {
      el.statusIndicator.className = 'status-indicator' + (status==='connected' ? ' connected' : '');
      el.connectionText.textContent = text;
      el.connectionStatus.textContent = text;
    }

    // ===== Participantes =====
    function getSerializableParticipants() {
      const out = [];
      for (const [peerId, data] of connections.entries()) out.push([peerId, { name: data.name, isHost: data.isHost, peerId: data.peerId }]);
      return out;
    }
    function updateParticipantsList() {
      const c = el.participantsContainer; c.innerHTML = '';
      connections.forEach(p => {
        const row = document.createElement('div'); row.className = 'participant';
        row.innerHTML = `<div class="participant-avatar">${p.name.charAt(0).toUpperCase()}</div>
          <div class="participant-info">
            <div class="participant-name">${p.name} ${p.peerId === (peer ? peer.id : '') ? '(Tú)' : ''}</div>
            <div class="participant-role">${p.isHost ? 'Host' : 'Invitado'}</div>
          </div>`;
        c.appendChild(row);
      });
      el.participantCount.textContent = connections.size;
    }
    function switchToVideoView() {
      el.setupCard.style.display = 'none';
      el.videoCard.style.display = 'block';
      el.statusCard.style.display = 'block';
      el.videoContainer.classList.add('active');
      el.sessionTitle.textContent = 'Sala: ' + roomCode;
      el.userRole.textContent = isHost ? 'Host' : 'Invitado';
      if (isHost) el.shareRoomBtn.style.display = 'inline-flex';
    }
    function generateShareLink(id) { const url = new URL(window.location.href); url.searchParams.set('room', id); return url.toString(); }
    function showShareModal() {
      const shareLink = generateShareLink(peer.id);
      el.shareLinkInput.value = shareLink;
      el.shareModal.classList.add('show');
      el.shareLinkInput.focus(); el.shareLinkInput.select();
    }

    // ===== Audio =====
    async function initializeAudio() {
      try {
        localAudioStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
        el.muteBtn.querySelector('.btn-text-desktop').textContent = 'Silenciar';
        el.muteBtn.querySelector('i').className = 'fas fa-microphone';
        return true;
      } catch(err) {
        showToast('No se pudo acceder al micrófono.', 'error'); console.error(err); return false;
      }
    }

    // ===== PeerJS =====
    function broadcastToAll(data){ connections.forEach(p => { if(p.conn && p.conn.open) p.conn.send(data); }); }
    async function handleIncomingData(data, conn) {
      switch (data.type) {
        case 'video-state-update':
          isVideoSyncing = true; el.mainVideo.currentTime = data.currentTime; data.isPlaying ? el.mainVideo.play() : el.mainVideo.pause(); break;
        case 'participant-update':
          const np = new Map(data.participants);
          connections = np; updateParticipantsList(); break;
        case 'initial-sync-request':
          if (isHost && conn) {
            const buf = await videoFile.arrayBuffer();
            conn.send({ type:'initial-sync-response', participants: getSerializableParticipants(), video: { buffer: buf, type: videoFile.type, currentTime: el.mainVideo.currentTime, isPlaying: !el.mainVideo.paused } });
          }
          break;
      }
    }
    function setupCallListeners(call) {
      call.on('stream', (remoteStream) => {
        if (document.getElementById('audio-'+call.peer)) return;
        const a = document.createElement('audio'); a.srcObject = remoteStream; a.autoplay = true; a.id = 'audio-'+call.peer;
        el.audioContainer.appendChild(a);
      });
      call.on('close', () => { document.getElementById('audio-'+call.peer)?.remove(); calls.delete(call.peer); });
      call.on('error', (err) => { console.error('Call error', err); showToast('Error de audio con '+call.peer, 'error'); });
      calls.set(call.peer, call);
    }
    function setupConnectionListeners(conn) {
      conn.on('data', (d) => handleIncomingData(d, conn));
      conn.on('open', () => {
        if (isHost) {
          connections.set(conn.peer, { conn, name: conn.metadata.name, isHost:false, peerId: conn.peer });
          broadcastToAll({ type:'participant-update', participants: getSerializableParticipants() });
          updateParticipantsList(); showToast(conn.metadata.name + ' se ha unido.');
        }
      });
      conn.on('close', () => {
        const u = connections.get(conn.peer);
        if (u) {
          showToast(u.name + ' se ha desconectado.');
          connections.delete(conn.peer); calls.get(conn.peer)?.close(); document.getElementById('audio-'+conn.peer)?.remove();
          broadcastToAll({ type:'participant-update', participants: getSerializableParticipants() }); updateParticipantsList();
        }
      });
      conn.on('error', (err) => { console.error('Conn error', err); showToast('Error de conexión con '+conn.peer, 'error'); });
    }

    // ===== Sala =====
    async function startHostSession() {
      playerName = el.playerName.value.trim();
      videoFile = el.videoFile.files[0];
      if (!playerName || !videoFile) { showToast('Debes elegir un nombre y un archivo de video.', 'error'); return; }
      setSetupStatus('Iniciando audio...', true); if (!await initializeAudio()) { setSetupStatus('Acceso al micrófono denegado.', false); return; }
      setSetupStatus('Creando sala en la red PeerJS...', true);
      isHost = true; peer = new Peer();
      peer.on('open', (id) => {
        roomCode = id; setSetupStatus(''); showShareModal();
        el.createRoomBtn.disabled = true;
        connections.set(peer.id, { conn:null, name: playerName, isHost:true, peerId: peer.id });
        updateParticipantsList(); el.mainVideo.src = URL.createObjectURL(videoFile); el.mainVideo.load();
        updateConnectionStatus('connected', 'Conectado como Host');
      });
      peer.on('connection', (conn) => setupConnectionListeners(conn));
      peer.on('call', (call) => { call.answer(localAudioStream); setupCallListeners(call); });
      peer.on('error', (err) => { console.error('PeerJS error', err); setSetupStatus('Error al crear la sala: ' + err.message, false); showToast('Error de PeerJS: ' + err.type, 'error'); });
    }

    async function joinGuestSession(code) {
      playerName = el.playerName.value.trim() || ('Player' + Math.floor(Math.random() * 999));
      roomCode = code;
      setSetupStatus('Iniciando audio...', true); if (!await initializeAudio()) { setSetupStatus('Acceso al micrófono denegado.', false); return; }
      setSetupStatus('Conectando a la sala ' + roomCode + '...', true);
      isHost = false; peer = new Peer();
      peer.on('open', () => {
        const dataConn = peer.connect(roomCode, { metadata: { name: playerName }, reliable:true });
        setupConnectionListeners(dataConn);
        dataConn.on('open', () => { setSetupStatus(''); updateConnectionStatus('connected','Conectado a la sala'); showToast('¡Conectado! Sincronizando...'); dataConn.send({ type:'initial-sync-request', peerId: peer.id }); });
        dataConn.on('data', (data) => {
          if (data.type === 'initial-sync-response') {
            const vb = data.video; const blob = new Blob([vb.buffer], { type: vb.type });
            el.mainVideo.src = URL.createObjectURL(blob); el.mainVideo.load(); el.mainVideo.currentTime = vb.currentTime; if (vb.isPlaying) el.mainVideo.play();
            const initP = new Map(data.participants);
            // Llamadas de audio a todos (incluye host)
            initP.forEach(p => { if (p.peerId !== peer.id) { const call = peer.call(p.peerId, localAudioStream); if (call) setupCallListeners(call); } });
            connections = initP; connections.set(peer.id, { conn: dataConn, name: playerName, isHost:false, peerId: peer.id });
            updateParticipantsList(); switchToVideoView();
          } else { handleIncomingData(data, dataConn); }
        });
      });
      peer.on('call', (call) => { call.answer(localAudioStream); setupCallListeners(call); });
      peer.on('error', (err) => { console.error('PeerJS error', err); setSetupStatus('Error al unirse: ' + err.message, false); showToast('Error de PeerJS: ' + err.type, 'error'); });
    }

    function leaveRoom() {
      if (peer) peer.destroy(); connections.clear(); calls.clear();
      if (localAudioStream) localAudioStream.getTracks().forEach(t=>t.stop());
      const v = el.mainVideo; if (v.src) URL.revokeObjectURL(v.src); v.src = ''; if (videoFile) videoFile = null;
      window.history.pushState({}, document.title, window.location.pathname); location.reload();
    }

    // ===== Video / Audio =====
    function syncVideoState(){ if (!peer || connections.size < 1) return; broadcastToAll({ type:'video-state-update', currentTime: el.mainVideo.currentTime, isPlaying: !el.mainVideo.paused }); }
    function toggleMute() {
      if (!localAudioStream) return; const track = localAudioStream.getAudioTracks()[0]; if (!track) return;
      track.enabled = !track.enabled; const muted = !track.enabled;
      el.muteBtn.querySelector('.btn-text-desktop').textContent = muted ? 'Activar Voz' : 'Silenciar';
      el.muteBtn.querySelector('i').className = muted ? 'fas fa-microphone-slash' : 'fas fa-microphone';
      showToast(muted ? 'Micrófono silenciado' : 'Micrófono activado');
    }
    async function toggleFullscreen() {
      const c = el.videoContainer;
      if (!document.fullscreenElement) {
        try { 
          await c.requestFullscreen(); 
          document.body.classList.add('cinema-mode');
        } catch(err){ console.error(err); }
      } else {
        try { 
          await document.exitFullscreen(); 
          document.body.classList.remove('cinema-mode');
        } catch(err){ console.error(err); }
      }
    }

    // ===== Eventos =====
    el.createRoomBtn?.addEventListener('click', startHostSession);
    el.leaveRoomBtn?.addEventListener('click', leaveRoom);
    el.shareRoomBtn?.addEventListener('click', showShareModal);
    el.muteBtn?.addEventListener('click', toggleMute);
    el.fullscreenOverlayBtn?.addEventListener('click', toggleFullscreen);

    el.mainVideo?.addEventListener('play',   () => { if (isVideoSyncing) { isVideoSyncing = false; return; } syncVideoState(); });
    el.mainVideo?.addEventListener('pause',  () => { if (isVideoSyncing) { isVideoSyncing = false; return; } syncVideoState(); });
    el.mainVideo?.addEventListener('seeked', () => { if (isVideoSyncing) { isVideoSyncing = false; return; } syncVideoState(); });

    el.enterRoomBtn?.addEventListener('click', () => { el.shareModal.classList.remove('show'); switchToVideoView(); });
    el.copyLinkBtn?.addEventListener('click', () => { el.shareLinkInput.select(); navigator.clipboard.writeText(el.shareLinkInput.value); showToast('Enlace copiado al portapapeles'); });
    el.shareBtn?.addEventListener('click', async () => {
      const shareData = { title:'Invitación a Watch Party', text:'¡Únete a mi sala!', url: el.shareLinkInput.value };
      if (navigator.share && navigator.canShare?.(shareData)) { try { await navigator.share(shareData); } catch(e){} }
      else { showToast('Compartir no disponible. ¡Copia el enlace!'); el.copyLinkBtn.click(); }
    });

    // Manual
    function openManual(){ el.manualModal.classList.add('show'); }
    function closeManual(){ el.manualModal.classList.remove('show'); }
    el.manualBtn?.addEventListener('click', openManual);
    el.manualOkBtn?.addEventListener('click', closeManual);
    el.manualModal?.addEventListener('click', (e)=>{ if(e.target===el.manualModal) closeManual(); });

    // Shortcuts
    document.addEventListener('keydown', (e) => {
      const t = e.target.tagName; if (t==='INPUT'||t==='TEXTAREA'||t==='SELECT') return;
      if (e.code === 'Space') { e.preventDefault(); if (el.mainVideo.paused) el.mainVideo.play(); else el.mainVideo.pause(); }
      if (e.key.toLowerCase() === 'm') toggleMute();
      if (e.key.toLowerCase() === 'f') toggleFullscreen();
      if (e.key === 'Escape') {
        if(document.fullscreenElement) document.exitFullscreen();
        el.shareModal.classList.remove('show'); 
        closeManual(); 
      }
    });
    
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        document.body.classList.remove('cinema-mode');
      }
    });

    // ===== Init + PWA + Auto-join por enlace =====
    document.addEventListener('DOMContentLoaded', () => {
      initThemeAndPalette();

      if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js', { scope:'./' }).catch(console.warn);
      window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; el.installBtn.style.display='inline-grid'; });
      el.installBtn?.addEventListener('click', async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; el.installBtn.style.display='none'; });

      if (typeof Peer === 'undefined') {
        setSetupStatus('Error: La librería de conexión no pudo cargarse.', false);
        showToast('Revisa tu conexión o bloqueador de anuncios.', 'error');
        el.createRoomBtn.disabled = true; return;
      }

      el.playerName.value = 'Player' + Math.floor(Math.random() * 999);

      const urlParams = new URLSearchParams(window.location.search);
      const roomFromUrl = urlParams.get('room');
      if (roomFromUrl) {
        // Guest flow: show join UI
        el.setupCard.querySelector('.mode-title').textContent = 'Unirse a una Sala';
        el.setupCard.querySelector('.mode-sub').textContent = 'Introduce tu nombre para entrar';
        
        const videoUploadSection = document.getElementById('videoUploadSection');
        if (videoUploadSection) {
            videoUploadSection.style.display = 'none';
            const grid = videoUploadSection.parentElement;
            if (grid.classList.contains('grid') && grid.classList.contains('two')) {
                grid.style.gridTemplateColumns = '1fr';
            }
        }
        
        if (el.createRoomBtn) el.createRoomBtn.style.display = 'none';
        if (el.joinRoomBtn) {
            el.joinRoomBtn.style.display = 'inline-flex';
            el.joinRoomBtn.addEventListener('click', () => {
                joinGuestSession(roomFromUrl);
            });
        }
        
        showToast('Invitación detectada. ¡Listo para unirte!');

      } else {
        // Host flow
        el.setupStatus.textContent = 'Crea una sala y envía una invitación.';
        if (el.createRoomBtn) el.createRoomBtn.style.display = 'inline-flex';
        if (el.joinRoomBtn) el.joinRoomBtn.style.display = 'none';
        
        const videoUploadSection = document.getElementById('videoUploadSection');
        if (videoUploadSection) {
            videoUploadSection.style.display = 'block';
            const grid = videoUploadSection.parentElement;
            if (grid.classList.contains('grid') && grid.classList.contains('two')) {
                grid.style.gridTemplateColumns = ''; // Reset to CSS default
            }
        }
      }

      console.log('Watch Party listo – Switch theme + paletas + mascota integrada');
    });

    window.addEventListener('beforeunload', () => { if (peer) peer.destroy(); });

    // Spinner keyframes inline
    const styleSpin = document.createElement('style'); styleSpin.textContent='@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}'; document.head.appendChild(styleSpin);
  </script>
</body>
</html>